"use client"

import { useState, useEffect } from "react"
import { Button } from "@/components/ui/button"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Slider } from "@/components/ui/slider"
import { Label } from "@/components/ui/label"
import { ArrowLeft, FileText, Languages, Share2, Loader2, Clock } from "lucide-react"
import { useParams, useRouter } from "next/navigation"
import { createClient } from "@/lib/supabase"
import Chatbot from '@/components/Chatbot'

interface Session {
  id: string
  title: string
  description?: string
  host_name: string
  category: string
  status: string
  summary?: string
  created_at: string
  ended_at?: string
}

interface Transcript {
  id: string
  original_text: string
  created_at: string
}

export default function PublicSessionSummaryPage() {
  const params = useParams()
  const router = useRouter()
  const supabase = createClient()
  const sessionId = params.id as string

  const [session, setSession] = useState<Session | null>(null)
  const [transcript, setTranscript] = useState<Transcript[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [fontSize, setFontSize] = useState([16])
  const [darkMode, setDarkMode] = useState(false)
  const [showFullTranscript, setShowFullTranscript] = useState(false)
  
  // Îã§Íµ≠Ïñ¥ ÏöîÏïΩ Í¥ÄÎ†® ÏÉÅÌÉú
  const [summary, setSummary] = useState<string>('')
  const [userLanguage, setUserLanguage] = useState('en')
  const [summaryLoading, setSummaryLoading] = useState(false)
  
  // Î≤àÏó≠ Í∏∞Îä• ÏÉÅÌÉú
  const [showTranslation, setShowTranslation] = useState(false)
  const [selectedLanguage, setSelectedLanguage] = useState('ko')
  const [translatedSummary, setTranslatedSummary] = useState<string>('')
  const [summaryTranslating, setSummaryTranslating] = useState(false)
  
  // üÜï Transcript Î≤àÏó≠ ÏÉÅÌÉú
  const [translatedTexts, setTranslatedTexts] = useState<Record<string, string>>({})
  const [translatingIds, setTranslatingIds] = useState<Set<string>>(new Set())

  // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏïÑÏù¥ÏΩò Îß§Ìïë
  const getCategoryIcon = (category: string) => {
    const icons: Record<string, string> = {
      sports: '‚öΩ',
      economics: 'üí∞',
      technology: 'üíª',
      education: 'üìö',
      business: 'üè¢',
      medical: 'üè•',
      legal: '‚öñÔ∏è',
      entertainment: 'üé¨',
      science: 'üî¨',
      general: 'üìã'
    }
    return icons[category] || 'üìã'
  }

  // ÏßÄÏõê Ïñ∏Ïñ¥ Î™©Î°ù
  const languages = [
    { code: "ko", name: "Korean", flag: "üá∞üá∑" },
    { code: "zh", name: "Chinese", flag: "üá®üá≥" },
    { code: "hi", name: "Hindi", flag: "üáÆüá≥" },
    { code: "en", name: "English", flag: "üá∫üá∏" },
  ]

  const getCategoryName = (category: string) => {
    const names: Record<string, Record<string, string>> = {
      en: {
        sports: 'Sports',
        economics: 'Economics', 
        technology: 'Technology',
        education: 'Education',
        business: 'Business',
        medical: 'Medical',
        legal: 'Legal',
        entertainment: 'Entertainment',
        science: 'Science',
        general: 'General'
      },
      ko: {
        sports: 'Ïä§Ìè¨Ï∏†',
        economics: 'Í≤ΩÏ†ú',
        technology: 'Í∏∞Ïà†',
        education: 'ÍµêÏú°',
        business: 'ÎπÑÏ¶àÎãàÏä§',
        medical: 'ÏùòÎ£å',
        legal: 'Î≤ïÎ•†',
        entertainment: 'ÏóîÌÑ∞ÌÖåÏù∏Î®ºÌä∏',
        science: 'Í≥ºÌïô',
        general: 'ÏùºÎ∞ò'
      },
      zh: {
        sports: '‰ΩìËÇ≤',
        economics: 'ÁªèÊµé',
        technology: 'ÊäÄÊúØ',
        education: 'ÊïôËÇ≤',
        business: 'ÂïÜ‰∏ö',
        medical: 'ÂåªÁñó',
        legal: 'Ê≥ïÂæã',
        entertainment: 'Â®±‰πê',
        science: 'ÁßëÂ≠¶',
        general: '‰∏ÄËà¨'
      },
      hi: {
        sports: '‡§ñ‡•á‡§≤',
        economics: '‡§Ö‡§∞‡•ç‡§•‡§∂‡§æ‡§∏‡•ç‡§§‡•ç‡§∞',
        technology: '‡§™‡•ç‡§∞‡•å‡§¶‡•ç‡§Ø‡•ã‡§ó‡§ø‡§ï‡•Ä',
        education: '‡§∂‡§ø‡§ï‡•ç‡§∑‡§æ',
        business: '‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞',
        medical: '‡§ö‡§ø‡§ï‡§ø‡§§‡•ç‡§∏‡§æ',
        legal: '‡§ï‡§æ‡§®‡•Ç‡§®‡•Ä',
        entertainment: '‡§Æ‡§®‡•ã‡§∞‡§Ç‡§ú‡§®',
        science: '‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§®',
        general: '‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø'
      }
    }
    return names[userLanguage]?.[category] || names['en'][category] || 'General'
  }

  // Îã§Íµ≠Ïñ¥ ÌÖçÏä§Ìä∏
  const t = (key: string) => {
    const texts: Record<string, Record<string, string>> = {
      en: {
        sessionSummary: 'Session Summary',
        completedSession: 'Completed Session',
        inProgress: 'In Progress',
        sessionTime: 'Session Duration',
        transcriptCount: 'Transcript Count',
        wordCount: 'Word Count',
        aiSummary: 'AI Summary',
        categoryBasedSummary: 'Category-based Summary',
        generatedBy: 'Generated by GPT-4',
        characters: 'characters',
        copySummary: 'Copy Summary',
        regenerate: 'Regenerate',
        fullTranscript: 'Full Transcript',
        realTimeResults: 'Real-time speech recognition results',
        expand: 'Expand',
        collapse: 'Collapse',
        copyAllTranscript: 'Copy All Transcript',
        publicAccess: 'This page is accessible to anyone. Share the link to share session content with others.',
        poweredBy: 'Powered by LiveTranscribe ‚Ä¢ Real-time Speech Recognition & AI Summary',
        fontSize: 'Font Size',
        darkMode: 'Dark Mode',
        share: 'Share',
        back: 'Back',
        sessionNotFound: 'Session not found',
        loadingSession: 'Loading session information...',
        goHome: 'Go Home',
        items: 'items',
        words: 'words',
        minutes: 'minutes'
      },
      ko: {
        sessionSummary: 'ÏÑ∏ÏÖò ÏöîÏïΩ',
        completedSession: 'ÏôÑÎ£åÎêú ÏÑ∏ÏÖò',
        inProgress: 'ÏßÑÌñâ Ï§ë',
        sessionTime: 'ÏÑ∏ÏÖò ÏãúÍ∞Ñ',
        transcriptCount: 'Î∞úÏñ∏ Ïàò',
        wordCount: 'Îã®Ïñ¥ Ïàò',
        aiSummary: 'AI ÏöîÏïΩ',
        categoryBasedSummary: 'Î∂ÑÏïº ÎßûÏ∂§ ÏöîÏïΩ',
        generatedBy: 'GPT-4Î°ú ÏÉùÏÑ±',
        characters: 'Í∏ÄÏûê',
        copySummary: 'ÏöîÏïΩ Î≥µÏÇ¨',
        regenerate: 'Ïû¨ÏÉùÏÑ±',
        fullTranscript: 'Ï†ÑÏ≤¥ Î∞úÏñ∏ Í∏∞Î°ù',
        realTimeResults: 'Ïã§ÏãúÍ∞Ñ ÏùåÏÑ± Ïù∏Ïãù Í≤∞Í≥º',
        expand: 'ÌéºÏπòÍ∏∞',
        collapse: 'Ï†ëÍ∏∞',
        copyAllTranscript: 'Ï†ÑÏ≤¥ Î∞úÏñ∏ Î≥µÏÇ¨',
        publicAccess: 'Ïù¥ ÌéòÏù¥ÏßÄÎäî ÎàÑÍµ¨ÎÇò Ï†ëÍ∑ºÌï† Ïàò ÏûàÏäµÎãàÎã§. ÎßÅÌÅ¨Î•º Í≥µÏú†ÌïòÏó¨ Îã§Î•∏ ÏÇ¨ÎûåÎì§Í≥º ÏÑ∏ÏÖò ÎÇ¥Ïö©ÏùÑ ÎÇòÎà†Î≥¥ÏÑ∏Ïöî.',
        poweredBy: 'Powered by LiveTranscribe ‚Ä¢ Ïã§ÏãúÍ∞Ñ ÏùåÏÑ± Ïù∏Ïãù Î∞è AI ÏöîÏïΩ',
        fontSize: 'Í∏ÄÏûê ÌÅ¨Í∏∞',
        darkMode: 'Îã§ÌÅ¨ Î™®Îìú',
        share: 'Í≥µÏú†',
        back: 'Îí§Î°úÍ∞ÄÍ∏∞',
        sessionNotFound: 'ÏÑ∏ÏÖòÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§',
        loadingSession: 'ÏÑ∏ÏÖò Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...',
        goHome: 'ÌôàÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞',
        items: 'Í∞ú',
        words: 'Í∞ú',
        minutes: 'Î∂Ñ'
      },
      zh: {
        sessionSummary: '‰ºöËØùÊëòË¶Å',
        completedSession: 'Â∑≤ÂÆåÊàê‰ºöËØù',
        inProgress: 'ËøõË°å‰∏≠',
        sessionTime: '‰ºöËØùÊó∂Èïø',
        transcriptCount: 'ÂèëË®ÄÊï∞Èáè',
        wordCount: 'ËØçÊï∞',
        aiSummary: 'AI ÊëòË¶Å',
        categoryBasedSummary: 'Âü∫‰∫éÁ±ªÂà´ÁöÑÊëòË¶Å',
        generatedBy: 'Áî± GPT-4 ÁîüÊàê',
        characters: 'Â≠óÁ¨¶',
        copySummary: 'Â§çÂà∂ÊëòË¶Å',
        regenerate: 'ÈáçÊñ∞ÁîüÊàê',
        fullTranscript: 'ÂÆåÊï¥ËÆ∞ÂΩï',
        realTimeResults: 'ÂÆûÊó∂ËØ≠Èü≥ËØÜÂà´ÁªìÊûú',
        expand: 'Â±ïÂºÄ',
        collapse: 'Êî∂Ëµ∑',
        copyAllTranscript: 'Â§çÂà∂ÂÖ®ÈÉ®ËÆ∞ÂΩï',
        publicAccess: 'Ê≠§È°µÈù¢‰ªª‰Ωï‰∫∫ÈÉΩÂèØ‰ª•ËÆøÈóÆ„ÄÇÂàÜ‰∫´ÈìæÊé•‰∏é‰ªñ‰∫∫ÂÖ±‰∫´‰ºöËØùÂÜÖÂÆπ„ÄÇ',
        poweredBy: 'Powered by LiveTranscribe ‚Ä¢ ÂÆûÊó∂ËØ≠Èü≥ËØÜÂà´Âíå AI ÊëòË¶Å',
        fontSize: 'Â≠ó‰ΩìÂ§ßÂ∞è',
        darkMode: 'Ê∑±Ëâ≤Ê®°Âºè',
        share: 'ÂàÜ‰∫´',
        back: 'ËøîÂõû',
        sessionNotFound: 'Êú™ÊâæÂà∞‰ºöËØù',
        loadingSession: 'Ê≠£Âú®Âä†ËΩΩ‰ºöËØù‰ø°ÊÅØ...',
        goHome: 'ÂõûÂà∞È¶ñÈ°µ',
        items: '‰∏™',
        words: '‰∏™',
        minutes: 'ÂàÜÈíü'
      },
      hi: {
        sessionSummary: '‡§∏‡§§‡•ç‡§∞ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂',
        completedSession: '‡§™‡•Ç‡§∞‡•ç‡§£ ‡§∏‡§§‡•ç‡§∞',
        inProgress: '‡§™‡•ç‡§∞‡§ó‡§§‡§ø ‡§Æ‡•á‡§Ç',
        sessionTime: '‡§∏‡§§‡•ç‡§∞ ‡§∏‡§Æ‡§Ø',
        transcriptCount: '‡§≠‡§æ‡§∑‡§£ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ',
        wordCount: '‡§∂‡§¨‡•ç‡§¶ ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ',
        aiSummary: 'AI ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂',
        categoryBasedSummary: '‡§∂‡•ç‡§∞‡•á‡§£‡•Ä ‡§Ü‡§ß‡§æ‡§∞‡§ø‡§§ ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂',
        generatedBy: 'GPT-4 ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§®',
        characters: '‡§µ‡§∞‡•ç‡§£',
        copySummary: '‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂ ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç',
        regenerate: '‡§™‡•Å‡§®‡§∞‡•ç‡§ú‡§®‡§®',
        fullTranscript: '‡§™‡•Ç‡§∞‡•ç‡§£ ‡§™‡•ç‡§∞‡§§‡§ø‡§≤‡•á‡§ñ',
        realTimeResults: '‡§µ‡§æ‡§∏‡•ç‡§§‡§µ‡§ø‡§ï ‡§∏‡§Æ‡§Ø ‡§≠‡§æ‡§∑‡§£ ‡§™‡§π‡§ö‡§æ‡§® ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ',
        expand: '‡§µ‡§ø‡§∏‡•ç‡§§‡§æ‡§∞',
        collapse: '‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§',
        copyAllTranscript: '‡§∏‡§≠‡•Ä ‡§™‡•ç‡§∞‡§§‡§ø‡§≤‡•á‡§ñ ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç',
        publicAccess: '‡§Ø‡§π ‡§™‡•É‡§∑‡•ç‡§† ‡§ï‡§ø‡§∏‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§≠‡•Ä ‡§∏‡•Å‡§≤‡§≠ ‡§π‡•à‡•§ ‡§≤‡§ø‡§Ç‡§ï ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡§ï‡•á ‡§¶‡•Ç‡§∏‡§∞‡•ã‡§Ç ‡§ï‡•á ‡§∏‡§æ‡§• ‡§∏‡§§‡•ç‡§∞ ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç‡•§',
        poweredBy: 'Powered by LiveTranscribe ‚Ä¢ ‡§µ‡§æ‡§∏‡•ç‡§§‡§µ‡§ø‡§ï ‡§∏‡§Æ‡§Ø ‡§≠‡§æ‡§∑‡§£ ‡§™‡§π‡§ö‡§æ‡§® ‡§î‡§∞ AI ‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂',
        fontSize: '‡§´‡§º‡•â‡§®‡•ç‡§ü ‡§Ü‡§ï‡§æ‡§∞',
        darkMode: '‡§°‡§æ‡§∞‡•ç‡§ï ‡§Æ‡•ã‡§°',
        share: '‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç',
        back: '‡§µ‡§æ‡§™‡§∏',
        sessionNotFound: '‡§∏‡§§‡•ç‡§∞ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ',
        loadingSession: '‡§∏‡§§‡•ç‡§∞ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...',
        goHome: '‡§π‡•ã‡§Æ ‡§™‡§∞ ‡§ú‡§æ‡§è‡§Ç',
        items: '',
        words: '',
        minutes: '‡§Æ‡§ø‡§®‡§ü'
      }
    }
    return texts[userLanguage]?.[key] || texts['en'][key] || key
  }

  // ÏÇ¨Ïö©Ïûê Ïñ∏Ïñ¥ Í∞êÏßÄ
  useEffect(() => {
    const detectLanguage = () => {
      if (typeof window !== 'undefined') {
        const browserLang = navigator.language.split('-')[0]
        const supportedLangs = ['ko', 'zh', 'hi', 'en']
        setUserLanguage(supportedLangs.includes(browserLang) ? browserLang : 'en')
      }
    }
    detectLanguage()
  }, [])

  // üÜï ÏöîÏïΩ Î≤àÏó≠ Ìï®Ïàò (ÏÉàÎ°úÏö¥ Ï∫êÏãú ÏãúÏä§ÌÖú ÏÇ¨Ïö©)
  const translateSummaryPublic = async (summaryText: string, targetLang: string) => {
    if (!summaryText || targetLang === 'en') {
      setTranslatedSummary(summaryText)
      return
    }

    setSummaryTranslating(true)
    
    try {
      // session_summary_cacheÏóêÏÑú Î≤àÏó≠Îêú ÏöîÏïΩ Ï∞æÍ∏∞
      const { data: cachedSummary, error } = await supabase
        .from('session_summary_cache')
        .select('summary_text')
        .eq('session_id', sessionId)
        .eq('language_code', targetLang)
        .maybeSingle()

      if (error) {
        console.error('Error loading summary translation:', error)
        setTranslatedSummary(summaryText) // Ïã§Ìå® Ïãú ÏòÅÏñ¥ ÏõêÎ¨∏ ÌëúÏãú
      } else if (cachedSummary) {
        setTranslatedSummary(cachedSummary.summary_text)
        console.log(`‚úÖ Loaded ${targetLang} summary translation from cache`)
      } else {
        console.log(`‚ö†Ô∏è No ${targetLang} summary translation found, using original`)
        setTranslatedSummary(summaryText)
      }
    } catch (error) {
      console.error('Error loading summary translation:', error)
      setTranslatedSummary(summaryText)
    } finally {
      setSummaryTranslating(false)
    }
  }

  // üÜï Transcript Î≤àÏó≠ Ìï®Ïàò (Í∏∞Ï°¥ translation_cache ÏÇ¨Ïö©)
  const translateText = async (text: string, targetLang: string): Promise<string> => {
    try {
      console.log(`üåç Loading translation: "${text.substring(0, 30)}..." ‚Üí ${targetLang}`)
      
      // translation_cacheÏóêÏÑú Í∏∞Ï°¥ Î≤àÏó≠ Ï∞æÍ∏∞
      const { data: cachedTranslation, error } = await supabase
        .from('translation_cache')
        .select('translated_text')
        .eq('original_text', text)
        .eq('target_language', targetLang)
        .maybeSingle()

      if (error) {
        console.error('Translation cache error:', error)
        return `[Î≤àÏó≠ Ïã§Ìå®] ${text}`
      }

      if (cachedTranslation) {
        console.log(`‚úÖ Found cached translation`)
        return cachedTranslation.translated_text
      } else {
        console.log(`‚ö†Ô∏è No cached translation found`)
        return `[${targetLang}] ${text}` // Î≤àÏó≠Ïù¥ ÏóÜÏúºÎ©¥ ÏõêÎ¨∏ ÌëúÏãú
      }
      
    } catch (error) {
      console.error('Translation error:', error)
      return `[Î≤àÏó≠ Ïã§Ìå®] ${text}`
    }
  }

  // üÜï ÏöîÏïΩ Î≤àÏó≠ Î°úÎìú Ìï®Ïàò (ÏÉàÎ°úÏö¥ Ï∫êÏãú ÏãúÏä§ÌÖú ÏÇ¨Ïö©)
  const loadSummaryTranslation = async (englishSummary: string, targetLang: string) => {
    if (!englishSummary || targetLang === 'en') {
      setSummary(englishSummary || '')
      return
    }

    setSummaryLoading(true)
    
    try {
      // session_summary_cacheÏóêÏÑú Î≤àÏó≠Îêú ÏöîÏïΩ Ï∞æÍ∏∞
      const { data: cachedSummary, error } = await supabase
        .from('session_summary_cache')
        .select('summary_text')
        .eq('session_id', sessionId)
        .eq('language_code', targetLang)
        .maybeSingle()

      if (error) {
        console.error('Error loading summary translation:', error)
        setSummary(englishSummary) // Ïã§Ìå® Ïãú ÏòÅÏñ¥ ÏõêÎ¨∏ ÌëúÏãú
      } else if (cachedSummary) {
        setSummary(cachedSummary.summary_text)
        console.log(`‚úÖ Loaded ${targetLang} summary translation from cache`)
      } else {
        console.log(`‚ö†Ô∏è No ${targetLang} translation found, showing English`)
        setSummary(englishSummary)
      }
    } catch (error) {
      console.error('Error loading summary translation:', error)
      setSummary(englishSummary)
    } finally {
      setSummaryLoading(false)
    }
  }

  // ÏÑ∏ÏÖò Î∞è transcript Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  useEffect(() => {
    const loadSessionData = async () => {
      if (!sessionId) return

      try {
        setLoading(true)
        setError(null)

        // ÏÑ∏ÏÖò Ï†ïÎ≥¥ Î°úÎìú (Í≥µÍ∞ú Ï†ëÍ∑º)
        const { data: sessionData, error: sessionError } = await supabase
          .from('sessions')
          .select('id, title, description, host_name, category, status, summary, created_at, ended_at')
          .eq('id', sessionId)
          .single()

        if (sessionError) {
          if (sessionError.code === 'PGRST116') {
            throw new Error('ÏÑ∏ÏÖòÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.')
          }
          throw sessionError
        }

        setSession(sessionData)

        // transcript Î°úÎìú (Í≥µÍ∞ú Ï†ëÍ∑º)
        const { data: transcripts, error: transcriptError } = await supabase
          .from('transcripts')
          .select('id, original_text, created_at')
          .eq('session_id', sessionId)
          .order('created_at', { ascending: true })

        if (transcriptError) {
          console.error('Transcript loading error:', transcriptError)
          // transcript ÏóêÎü¨Îäî Î¨¥ÏãúÌïòÍ≥† Í≥ÑÏÜç ÏßÑÌñâ
        } else {
          setTranscript(transcripts || [])
        }

        // ÏöîÏïΩ Î≤àÏó≠ Î°úÎìú
        await loadSummaryTranslation(sessionData.summary, userLanguage)

      } catch (error) {
        console.error('Error loading session data:', error)
        setError(error instanceof Error ? error.message : 'Unknown error')
      } finally {
        setLoading(false)
      }
    }

    loadSessionData()
  }, [sessionId, supabase])

  // Ïñ∏Ïñ¥ Î≥ÄÍ≤Ω Ïãú ÏöîÏïΩ Ïû¨Î°úÎìú (ÏûêÎèô)
  useEffect(() => {
    if (session?.summary) {
      loadSummaryTranslation(session.summary, userLanguage)
    }
  }, [userLanguage, session?.summary])

  // Î≤àÏó≠ ÌÜ†Í∏Ä Ïãú ÏöîÏïΩ Î≤àÏó≠ Ïã§Ìñâ
  useEffect(() => {
    if (session?.summary && showTranslation) {
      translateSummaryPublic(session.summary, selectedLanguage)
    } else if (session?.summary) {
      setTranslatedSummary(session.summary) // Î≤àÏó≠ ÎπÑÌôúÏÑ±Ìôî Ïãú ÏõêÎ¨∏ ÌëúÏãú
    }
  }, [session?.summary, selectedLanguage, showTranslation])

  // üÜï Transcript Î≤àÏó≠ ÌôúÏÑ±Ìôî/Ïñ∏Ïñ¥ Î≥ÄÍ≤ΩÏãú Î≤àÏó≠ ÏàòÌñâ
  useEffect(() => {
    if (!showTranslation) {
      setTranslatedTexts({})
      setTranslatingIds(new Set())
      return
    }

    const translateAllTexts = async () => {
      console.log(`üîÑ Starting batch translation for ${transcript.length} items`)
      setTranslatingIds(new Set(transcript.map(t => t.id)))
      
      const newTranslatedTexts: Record<string, string> = {}
      
      // Î≥ëÎ†¨Î°ú Î≤àÏó≠ (ÏµúÎåÄ 3Í∞úÏî©)
      for (let i = 0; i < transcript.length; i += 3) {
        const batch = transcript.slice(i, i + 3)
        
        await Promise.all(batch.map(async (item) => {
          try {
            const translated = await translateText(item.original_text, selectedLanguage)
            newTranslatedTexts[item.id] = translated
            
            // Í∞úÎ≥Ñ ÏôÑÎ£åÏãúÎßàÎã§ UI ÏóÖÎç∞Ïù¥Ìä∏
            setTranslatedTexts(prev => ({ ...prev, [item.id]: translated }))
            setTranslatingIds(prev => {
              const newSet = new Set(prev)
              newSet.delete(item.id)
              return newSet
            })
          } catch (error) {
            console.error(`Translation failed for ${item.id}:`, error)
            setTranslatingIds(prev => {
              const newSet = new Set(prev)
              newSet.delete(item.id)
              return newSet
            })
          }
        }))
        
        // Î∞∞Ïπò Í∞Ñ ÏßßÏùÄ ÎîúÎ†àÏù¥
        if (i + 3 < transcript.length) {
          await new Promise(resolve => setTimeout(resolve, 200))
        }
      }
      
      console.log(`‚úÖ Batch translation completed`)
    }

    if (transcript.length > 0) {
      translateAllTexts()
    }
  }, [showTranslation, selectedLanguage, transcript])

  // ÌÖçÏä§Ìä∏ Î≥µÏÇ¨ Í∏∞Îä•
  const copyText = async (text: string, type: string) => {
    try {
      await navigator.clipboard.writeText(text)
      const successMessage = userLanguage === 'ko' ? `${type}Ïù¥(Í∞Ä) ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.` :
                            userLanguage === 'zh' ? `${type}Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø` :
                            userLanguage === 'hi' ? `${type} ‡§ï‡•ç‡§≤‡§ø‡§™‡§¨‡•ã‡§∞‡•ç‡§° ‡§Æ‡•á‡§Ç ‡§ï‡•â‡§™‡•Ä ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ` :
                            `${type} copied to clipboard`
      alert(successMessage)
    } catch (error) {
      console.error('Copy failed:', error)
      const errorMessage = userLanguage === 'ko' ? 'Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.' :
                          userLanguage === 'zh' ? 'Â§çÂà∂Â§±Ë¥•' :
                          userLanguage === 'hi' ? '‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤' :
                          'Copy failed'
      alert(errorMessage)
    }
  }

  // ÎßÅÌÅ¨ Î≥µÏÇ¨ Í∏∞Îä•
  const copyLink = async () => {
    const url = window.location.href
    try {
      await navigator.clipboard.writeText(url)
      const successMessage = userLanguage === 'ko' ? 'ÎßÅÌÅ¨Í∞Ä ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!' :
                            userLanguage === 'zh' ? 'ÈìæÊé•Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ' :
                            userLanguage === 'hi' ? '‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•ç‡§≤‡§ø‡§™‡§¨‡•ã‡§∞‡•ç‡§° ‡§Æ‡•á‡§Ç ‡§ï‡•â‡§™‡•Ä ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!' :
                            'Link copied to clipboard!'
      
      // Toast ÏïåÎ¶º (Í∞ÑÎã®Ìïú Î∏åÎùºÏö∞Ï†Ä ÏïåÎ¶ºÏúºÎ°ú ÎåÄÏ≤¥)
      if (typeof window !== 'undefined') {
        // Í∞ÑÎã®Ìïú toast Ïä§ÌÉÄÏùº ÏïåÎ¶º
        const toast = document.createElement('div')
        toast.textContent = successMessage
        toast.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: #10b981;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          font-size: 14px;
          z-index: 9999;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          animation: slideIn 0.3s ease-out;
        `
        
        // CSS Ïï†ÎãàÎ©îÏù¥ÏÖò Ï∂îÍ∞Ä
        const style = document.createElement('style')
        style.textContent = `
          @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
        `
        document.head.appendChild(style)
        document.body.appendChild(toast)
        
        // 3Ï¥à ÌõÑ Ï†úÍ±∞
        setTimeout(() => {
          toast.remove()
          style.remove()
        }, 3000)
      }
    } catch (error) {
      console.error('Copy failed:', error)
      const errorMessage = userLanguage === 'ko' ? 'Î≥µÏÇ¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.' :
                          userLanguage === 'zh' ? 'Â§çÂà∂Â§±Ë¥•' :
                          userLanguage === 'hi' ? '‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤' :
                          'Copy failed'
      alert(errorMessage)
    }
  }

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="flex flex-col items-center space-y-4">
          <Loader2 className="h-8 w-8 animate-spin text-blue-600" />
          <p className="text-gray-600">{t('loadingSession')}</p>
        </div>
      </div>
    )
  }

  if (error) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="flex flex-col items-center space-y-4">
          <FileText className="h-8 w-8 text-red-600" />
          <p className="text-gray-900 font-medium">{t('sessionNotFound')}</p>
          <p className="text-gray-600 text-sm text-center">{error}</p>
          <Button onClick={() => router.push('/')} variant="outline">
            {t('goHome')}
          </Button>
        </div>
      </div>
    )
  }

  if (!session) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <p className="text-gray-600">{t('sessionNotFound')}</p>
      </div>
    )
  }

  const formatDuration = () => {
    if (!session.created_at || !session.ended_at) return 'N/A'
    const start = new Date(session.created_at)
    const end = new Date(session.ended_at)
    const duration = Math.floor((end.getTime() - start.getTime()) / 1000 / 60)
    return `${duration}${t('minutes')}`
  }

  return (
    <div className={`min-h-screen ${darkMode ? 'dark bg-gray-900' : 'bg-gray-50'}`}>
      {/* Header */}
      <header className={`border-b sticky top-0 z-40 ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white'}`}>
        <div className="container mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-4">
                             <Button variant="ghost" size="sm" onClick={() => router.back()} className="pl-0 pr-2 -ml-2">
                 <ArrowLeft className="h-4 w-4 mr-2" />
                 {t('back')}
               </Button>
               <div>
                 <h1 className={`text-lg font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                   {session.title}
                 </h1>
                 <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                   {t('sessionSummary')} ‚Ä¢ {session.host_name}
                 </p>
               </div>
             </div>
             <div className="flex items-center space-x-2">
               <Button 
                 variant="outline" 
                 size="sm"
                 onClick={() => setShowTranslation(!showTranslation)}
                 className="flex items-center space-x-2"
               >
                 <Languages className="h-4 w-4" />
                 <span>{showTranslation ? 'Hide' : 'Show'} Translation</span>
               </Button>
               <Button variant="outline" size="sm" onClick={copyLink}>
                 <Share2 className="h-4 w-4 mr-2" />
                 Copy Link
               </Button>
            </div>
          </div>
        </div>
      </header>

      {/* Settings */}
      <div className={`border-b ${darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white'} p-4`}>
        <div className="container mx-auto">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-6">
              {/* Translation Settings */}
              {showTranslation && (
                <div className="flex items-center space-x-2">
                  <Label className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                    Language:
                  </Label>
                  <select
                    value={selectedLanguage}
                    onChange={(e) => setSelectedLanguage(e.target.value)}
                    className={`px-2 py-1 rounded border text-sm ${
                      darkMode 
                        ? 'bg-gray-700 border-gray-600 text-white' 
                        : 'bg-white border-gray-300 text-gray-900'
                    }`}
                  >
                    {languages.map((lang) => (
                      <option key={lang.code} value={lang.code}>
                        {lang.flag} {lang.name}
                      </option>
                    ))}
                  </select>
                </div>
              )}
              <div className="flex items-center space-x-2">
                                 <Label className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                   {t('fontSize')}: {fontSize[0]}px
                 </Label>
                <Slider
                  value={fontSize}
                  onValueChange={setFontSize}
                  max={24}
                  min={12}
                  step={2}
                  className="w-24"
                />
              </div>
              <div className="flex items-center space-x-2">
                <input
                  type="checkbox"
                  id="darkMode"
                  checked={darkMode}
                  onChange={(e) => setDarkMode(e.target.checked)}
                  className="rounded"
                />
                                 <Label htmlFor="darkMode" className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-700'}`}>
                   {t('darkMode')}
                 </Label>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="container mx-auto px-4 py-6">
        <div className="max-w-4xl mx-auto space-y-6">
          
          {/* Session Info */}
          <Card className={darkMode ? 'bg-gray-800 border-gray-700' : ''}>
            <CardHeader>
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-3">
                  <div className={`p-2 rounded-full ${
                    darkMode ? 'bg-blue-900 text-blue-300' : 'bg-blue-100 text-blue-600'
                  }`}>
                    <span className="text-lg">{getCategoryIcon(session.category)}</span>
                  </div>
                  <div>
                    <CardTitle className={darkMode ? 'text-white' : 'text-gray-900'}>
                      {session.title}
                    </CardTitle>
                    <CardDescription className={darkMode ? 'text-gray-400' : 'text-gray-600'}>
                      {getCategoryName(session.category)} ‚Ä¢ {session.host_name}
                    </CardDescription>
                  </div>
                </div>
                                 <div className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                   {session.status === 'ended' ? t('completedSession') : t('inProgress')}
                 </div>
              </div>
            </CardHeader>
            {session.description && (
              <CardContent>
                <p className={`${darkMode ? 'text-gray-300' : 'text-gray-700'}`} style={{ fontSize: `${fontSize[0]}px` }}>
                  {session.description}
                </p>
              </CardContent>
            )}
          </Card>

          {/* Session Stats */}
          <div className="grid md:grid-cols-3 gap-4">
            <Card className={darkMode ? 'bg-gray-800 border-gray-700' : ''}>
              <CardContent className="p-4 text-center">
                <Clock className={`h-6 w-6 mx-auto mb-2 ${darkMode ? 'text-blue-400' : 'text-blue-600'}`} />
                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{t('sessionTime')}</p>
                <p className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                  {formatDuration()}
                </p>
              </CardContent>
            </Card>
            <Card className={darkMode ? 'bg-gray-800 border-gray-700' : ''}>
              <CardContent className="p-4 text-center">
                <FileText className={`h-6 w-6 mx-auto mb-2 ${darkMode ? 'text-green-400' : 'text-green-600'}`} />
                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{t('transcriptCount')}</p>
                <p className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                  {transcript.length}{t('items')}
                </p>
              </CardContent>
            </Card>
            <Card className={darkMode ? 'bg-gray-800 border-gray-700' : ''}>
              <CardContent className="p-4 text-center">
                <Languages className={`h-6 w-6 mx-auto mb-2 ${darkMode ? 'text-purple-400' : 'text-purple-600'}`} />
                <p className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>{t('wordCount')}</p>
                <p className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                  {transcript.reduce((total, t) => total + t.original_text.split(' ').length, 0)}{t('words')}
                </p>
              </CardContent>
            </Card>
          </div>

          {/* Summary Section */}
          {(session.summary || summary) && (
            <Card className={`${darkMode ? 'bg-gray-800 border-gray-700' : ''} border-2 border-dashed ${
              darkMode ? 'border-blue-600' : 'border-blue-200'
            }`}>
              <CardHeader>
                <CardTitle className={`flex items-center space-x-2 ${darkMode ? 'text-white' : 'text-gray-900'}`}>
                  <FileText className="h-5 w-5" />
                  <span>{t('aiSummary')}</span>
                </CardTitle>
                <CardDescription className={darkMode ? 'text-gray-400' : 'text-gray-600'}>
                  {getCategoryIcon(session.category)} {getCategoryName(session.category)} {t('categoryBasedSummary')}
                </CardDescription>
              </CardHeader>
              <CardContent>
                                 {summaryLoading ? (
                   <div className="flex items-center justify-center py-8">
                     <Loader2 className="h-6 w-6 animate-spin text-blue-600 mr-2" />
                     <span className={darkMode ? 'text-gray-300' : 'text-gray-700'}>
                       Loading {userLanguage} translation...
                     </span>
                   </div>
                 ) : (
                   <>
                     {summaryTranslating && (
                       <div className="flex items-center space-x-2 mb-2">
                         <Loader2 className="h-4 w-4 animate-spin text-blue-600" />
                         <span className={`text-sm ${darkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                           Translating summary to {languages.find(l => l.code === selectedLanguage)?.name}...
                         </span>
                       </div>
                     )}
                     <div 
                       className={`leading-relaxed mb-4 ${darkMode ? 'text-gray-100' : 'text-gray-800'}`}
                       style={{ fontSize: `${fontSize[0]}px` }}
                     >
                       {(() => {
                         if (showTranslation && selectedLanguage !== 'en') {
                           return <span dangerouslySetInnerHTML={{ __html: translatedSummary || session.summary || '' }} />
                         }
                         return <span dangerouslySetInnerHTML={{ __html: summary || session.summary || '' }} />
                       })()}
                     </div>
                    <div className="flex items-center justify-between pt-4 border-t border-gray-200 dark:border-gray-600">
                                             <div className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                         {t('generatedBy')} ‚Ä¢ {(() => {
                           if (showTranslation && selectedLanguage !== 'en') {
                             return (translatedSummary || session.summary || '').length
                           }
                           return (summary || session.summary || '').length
                         })()} {t('characters')}
                         {showTranslation && selectedLanguage !== 'en' && translatedSummary && (
                           <span> ‚Ä¢ Translated to {languages.find(l => l.code === selectedLanguage)?.name}</span>
                         )}
                       </div>
                       <Button
                         variant="ghost"
                         size="sm"
                         onClick={() => {
                           const summaryToCopy = (() => {
                             if (showTranslation && selectedLanguage !== 'en') {
                               return translatedSummary || session.summary || ''
                             }
                             return summary || session.summary || ''
                           })()
                           copyText(summaryToCopy, t('copySummary'))
                         }}
                       >
                         üìã {t('copySummary')}
                       </Button>
                    </div>
                  </>
                )}
              </CardContent>
            </Card>
          )}

          {/* Transcript Section */}
          {transcript.length > 0 && (
            <Card className={darkMode ? 'bg-gray-800 border-gray-700' : ''}>
              <CardHeader>
                <div className="flex items-center justify-between">
                                  <CardTitle className={darkMode ? 'text-white' : 'text-gray-900'}>
                  {t('fullTranscript')}
                </CardTitle>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setShowFullTranscript(!showFullTranscript)}
                >
                  {showFullTranscript ? t('collapse') : t('expand')}
                </Button>
                </div>
                <CardDescription className={darkMode ? 'text-gray-400' : 'text-gray-600'}>
                  {transcript.length}{t('items')} ‚Ä¢ {t('realTimeResults')}
                </CardDescription>
              </CardHeader>
              {showFullTranscript && (
                <CardContent>
                  <div className="space-y-3 max-h-96 overflow-y-auto">
                    {transcript.map((item, index) => (
                      <div key={item.id} className={`p-3 rounded-lg ${
                        darkMode ? 'bg-gray-700' : 'bg-gray-50'
                      }`}>
                        <div className={`text-xs mb-1 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
                          #{index + 1} ‚Ä¢ {new Date(item.created_at).toLocaleTimeString()}
                        </div>
                        <div 
                          className={`${darkMode ? 'text-gray-100' : 'text-gray-900'}`}
                          style={{ fontSize: `${fontSize[0]}px` }}
                        >
                          {item.original_text}
                        </div>
                        
                        {/* üÜï Translation Display */}
                        {showTranslation && (
                          <div 
                            className={`mt-2 leading-relaxed italic pl-4 border-l-2 ${
                              darkMode 
                                ? 'text-gray-300 border-gray-600' 
                                : 'text-gray-700 border-gray-300'
                            }`}
                            style={{ fontSize: `${fontSize[0] - 1}px` }}
                          >
                            {translatingIds.has(item.id) ? (
                              <span className="text-gray-400 flex items-center">
                                <div className="w-3 h-3 border border-gray-400 border-t-transparent rounded-full animate-spin mr-2"></div>
                                [AI Î≤àÏó≠ Ï§ë...]
                              </span>
                            ) : (
                              translatedTexts[item.id] || `[${languages.find(l => l.code === selectedLanguage)?.name}] ${item.original_text}`
                            )}
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                  <div className="mt-4 pt-4 border-t border-gray-200 dark:border-gray-600">
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => copyText(
                        transcript.map((t, i) => `${i + 1}. ${t.original_text}`).join('\n\n'),
                        t('copyAllTranscript')
                      )}
                    >
                      üìã {t('copyAllTranscript')}
                    </Button>
                  </div>
                </CardContent>
              )}
            </Card>
          )}

          {/* Chatbot for past session */}
          <Chatbot transcript={transcript.map(line => line.original_text).join('\n')} sessionId={sessionId} />

          {/* Footer */}
          <div className={`text-center py-8 ${darkMode ? 'text-gray-400' : 'text-gray-500'}`}>
            <p className="text-sm">
              {t('publicAccess')}
            </p>
            <p className="text-xs mt-2">
              {t('poweredBy')}
            </p>
          </div>
        </div>
      </div>
    </div>
  )
} 